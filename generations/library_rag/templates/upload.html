{% extends "base.html" %}

{% block title %}Upload Document{% endblock %}

{% block content %}
<section class="section">
    <h1>üìÑ Parser PDF/Word/Markdown</h1>
    <p class="lead">Uploadez un document pour l'analyser et l'indexer dans Weaviate</p>

    {% if error %}
        <div class="alert alert-warning">
            <strong>Erreur :</strong> {{ error }}
        </div>
    {% endif %}

    <div class="search-box">
        <form method="post" enctype="multipart/form-data">
            <!-- S√©lection du fichier -->
            <div class="form-group">
                <label class="form-label" for="file">üìé S√©lectionnez votre fichier (ou plusieurs)</label>
                <input
                    type="file"
                    name="file"
                    id="file"
                    class="form-control"
                    accept=".pdf,.docx,.md"
                    required
                    multiple
                    onchange="updateOptionsForFileType()"
                >
                <div class="caption mt-1">
                    Formats accept√©s : PDF (.pdf), Word (.docx) ou Markdown (.md) ‚Ä¢ Max 50 MB par fichier<br>
                    <span id="file-count-info" style="font-weight: 600; color: #2196F3;"></span>
                </div>
            </div>

            <!-- Configuration recommand√©e (par d√©faut) -->
            <div class="card mt-4" style="border-left: 3px solid #2196F3;">
                <h4 style="color: #2196F3;">‚öôÔ∏è Configuration (Recommand√©e)</h4>
                <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                    Les options ci-dessous sont pr√©-configur√©es pour un traitement optimal.
                    <strong>Vous pouvez simplement cliquer sur "Analyser" !</strong>
                </p>

                <!-- Options communes -->
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input
                            type="checkbox"
                            name="use_llm"
                            id="use_llm"
                            checked
                            style="width: auto;"
                        >
                        <label for="use_llm" style="margin: 0; font-weight: 600;">
                            ‚úÖ Structuration intelligente avec LLM
                        </label>
                    </div>
                    <div style="margin-left: 1.5rem; color: #666; font-size: 0.85rem;">
                        Extraction automatique des m√©tadonn√©es, chapitres, et d√©coupage s√©mantique
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input
                            type="checkbox"
                            name="ingest_weaviate"
                            id="ingest_weaviate"
                            checked
                            style="width: auto;"
                        >
                        <label for="ingest_weaviate" style="margin: 0; font-weight: 600;">
                            ‚úÖ Indexer dans Weaviate (recherche s√©mantique)
                        </label>
                    </div>
                    <div style="margin-left: 1.5rem; color: #666; font-size: 0.85rem;">
                        Permet de rechercher le contenu du document via l'interface de recherche
                    </div>
                </div>

                <!-- Options PDF uniquement -->
                <div id="pdf-only-options" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input
                            type="checkbox"
                            name="skip_ocr"
                            id="skip_ocr"
                            style="width: auto;"
                        >
                        <label for="skip_ocr" style="margin: 0; font-weight: 600;">
                            ‚ö° Skip OCR (r√©utiliser markdown existant)
                        </label>
                    </div>
                    <div style="margin-left: 1.5rem; color: #666; font-size: 0.85rem;">
                        Utile pour retester un PDF d√©j√† trait√© (√©vite les frais d'OCR ~0.003‚Ç¨/page)
                    </div>

                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem;">
                        <input
                            type="checkbox"
                            name="use_ocr_annotations"
                            id="use_ocr_annotations"
                            checked
                            style="width: auto;"
                        >
                        <label for="use_ocr_annotations" style="margin: 0; font-weight: 600;">
                            üìë Extraction TOC am√©lior√©e
                        </label>
                    </div>
                    <div style="margin-left: 1.5rem; color: #666; font-size: 0.85rem;">
                        Analyse l'indentation pour mieux d√©tecter la table des mati√®res
                    </div>
                </div>

                <!-- Word/Markdown info -->
                <div id="word-info" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #e8f5e9; border-radius: 4px;">
                    <strong style="color: #2e7d32;">‚ú® Fichier Word d√©tect√©</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #555;">
                        Extraction directe du contenu ‚Ä¢ Pas d'OCR n√©cessaire ‚Ä¢ TOC depuis les styles Heading
                    </p>
                </div>
                <div id="markdown-info" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #fff3e0; border-radius: 4px;">
                    <strong style="color: #e65100;">‚ú® Fichier Markdown d√©tect√©</strong>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: #555;">
                        Fichier d√©j√† au format Markdown ‚Ä¢ Pas d'OCR n√©cessaire ‚Ä¢ Traitement direct
                    </p>
                </div>
            </div>

            <!-- Options avanc√©es (repliables) -->
            <details class="mt-3" style="cursor: pointer;">
                <summary style="font-weight: 600; color: #666; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                    ‚öôÔ∏è Options avanc√©es (cliquer pour afficher)
                </summary>
                <div style="margin-top: 1rem; padding: 1rem; border: 1px solid #ddd; border-radius: 4px;">
                    <div class="form-group">
                        <label class="form-label" for="llm_provider">Provider LLM</label>
                        <select name="llm_provider" id="llm_provider" class="form-control" onchange="updateModelOptions()">
                            <option value="mistral" selected>‚ö° Mistral API (rapide, recommand√©)</option>
                            <option value="ollama">üñ•Ô∏è Ollama (local, gratuit, lent)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="llm_model">Mod√®le LLM</label>
                        <select name="llm_model" id="llm_model" class="form-control">
                            <option value="mistral-small-latest" selected>mistral-small (rapide, √©conomique)</option>
                            <option value="mistral-medium-latest">mistral-medium (√©quilibr√©)</option>
                            <option value="mistral-large-latest">mistral-large (puissant)</option>
                        </select>
                    </div>
                </div>
            </details>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
                    üöÄ Analyser le document
                </button>
            </div>
        </form>
    </div>

    <hr class="divider">

    <!-- Informations sur le pipeline -->
    <div class="card">
        <h3>üìã Pipeline de traitement</h3>
        <div class="mt-2">
            <div id="pdf-pipeline-info">
                <p><strong>PDF:</strong></p>
                <p style="margin-left: 1rem;">1. OCR Mistral ‚Äî Extraction du texte et des images</p>
                <p style="margin-left: 1rem;">2. Markdown ‚Äî Construction du document structur√©</p>
                <p style="margin-left: 1rem;">3. LLM ‚Äî Extraction m√©tadonn√©es, TOC, classification</p>
                <p style="margin-left: 1rem;">4. Chunking ‚Äî D√©coupage s√©mantique intelligent</p>
                <p style="margin-left: 1rem;">5. Weaviate ‚Äî Vectorisation et indexation</p>
            </div>

            <div id="word-pipeline-info" style="display: none;">
                <p><strong>Word (.docx):</strong></p>
                <p style="margin-left: 1rem;">1. Extraction ‚Äî Lecture directe du contenu Word</p>
                <p style="margin-left: 1rem;">2. Markdown ‚Äî Conversion avec styles pr√©serv√©s</p>
                <p style="margin-left: 1rem;">3. TOC ‚Äî Extraction depuis Heading 1-9</p>
                <p style="margin-left: 1rem;">4. LLM ‚Äî M√©tadonn√©es et structuration</p>
                <p style="margin-left: 1rem;">5. Weaviate ‚Äî Vectorisation et indexation</p>
            </div>

            <div id="markdown-pipeline-info" style="display: none;">
                <p><strong>Markdown (.md):</strong></p>
                <p style="margin-left: 1rem;">1. Lecture ‚Äî Fichier d√©j√† au format Markdown</p>
                <p style="margin-left: 1rem;">2. TOC ‚Äî Analyse des titres # ##</p>
                <p style="margin-left: 1rem;">3. LLM ‚Äî M√©tadonn√©es et structuration</p>
                <p style="margin-left: 1rem;">4. Chunking ‚Äî D√©coupage s√©mantique</p>
                <p style="margin-left: 1rem;">5. Weaviate ‚Äî Vectorisation et indexation</p>
            </div>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="/documents" class="btn">üìö Voir les documents trait√©s</a>
    </div>
</section>

<script>
function updateModelOptions() {
    const provider = document.getElementById('llm_provider').value;
    const modelSelect = document.getElementById('llm_model');

    if (provider === 'mistral') {
        modelSelect.innerHTML = `
            <option value="mistral-small-latest" selected>mistral-small (rapide, √©conomique)</option>
            <option value="mistral-medium-latest">mistral-medium (√©quilibr√©)</option>
            <option value="mistral-large-latest">mistral-large (puissant)</option>
        `;
    } else {
        modelSelect.innerHTML = `
            <option value="qwen2.5:7b" selected>qwen2.5:7b (recommand√©)</option>
            <option value="qwen2.5:14b">qwen2.5:14b</option>
            <option value="llama3.2:3b">llama3.2:3b (rapide)</option>
            <option value="mistral:7b">mistral:7b</option>
        `;
    }
}

function updateOptionsForFileType() {
    const fileInput = document.getElementById('file');
    const fileCountInfo = document.getElementById('file-count-info');
    const fileCount = fileInput.files.length;

    // Update file count display
    if (fileCount === 0) {
        fileCountInfo.textContent = '';
    } else if (fileCount === 1) {
        fileCountInfo.textContent = '';
    } else {
        fileCountInfo.textContent = `üì¶ ${fileCount} fichiers s√©lectionn√©s (traitement s√©quentiel : un fichier apr√®s l'autre)`;
    }

    const fileName = fileInput.files[0]?.name || '';
    const isWord = fileName.toLowerCase().endsWith('.docx');
    const isPDF = fileName.toLowerCase().endsWith('.pdf');
    const isMarkdown = fileName.toLowerCase().endsWith('.md');

    // R√©cup√©rer tous les √©l√©ments
    const pdfOptions = document.getElementById('pdf-only-options');
    const wordInfo = document.getElementById('word-info');
    const markdownInfo = document.getElementById('markdown-info');
    const pdfPipelineInfo = document.getElementById('pdf-pipeline-info');
    const wordPipelineInfo = document.getElementById('word-pipeline-info');
    const markdownPipelineInfo = document.getElementById('markdown-pipeline-info');

    // Masquer tout par d√©faut
    pdfOptions.style.display = 'none';
    wordInfo.style.display = 'none';
    markdownInfo.style.display = 'none';
    pdfPipelineInfo.style.display = 'none';
    wordPipelineInfo.style.display = 'none';
    markdownPipelineInfo.style.display = 'none';

    // Afficher selon le type (bas√© sur le premier fichier)
    if (isWord) {
        wordInfo.style.display = 'block';
        wordPipelineInfo.style.display = 'block';
    } else if (isPDF) {
        pdfOptions.style.display = 'block';
        pdfPipelineInfo.style.display = 'block';
    } else if (isMarkdown) {
        markdownInfo.style.display = 'block';
        markdownPipelineInfo.style.display = 'block';
    }
}
</script>
{% endblock %}
