{% extends "base.html" %}

{% block title %}Upload Document{% endblock %}

{% block content %}
<section class="section">
    <h1>üìÑ Parser PDF/Word/Markdown</h1>
    <p class="lead">Uploadez un fichier PDF, Word (.docx) ou Markdown pour l'analyser et structurer son contenu</p>

    {% if error %}
        <div class="alert alert-warning">
            <strong>Erreur :</strong> {{ error }}
        </div>
    {% endif %}

    <div class="search-box">
        <form method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label class="form-label" for="file">Fichier PDF, Word ou Markdown</label>
                <input
                    type="file"
                    name="file"
                    id="file"
                    class="form-control"
                    accept=".pdf,.docx,.md"
                    required
                >
                <div class="caption mt-1">Taille maximale : 50 MB</div>
                <div class="caption" style="color: var(--color-accent); margin-top: 0.25rem;">
                    üí° PDF: Pour retester sans refaire l'OCR payant, cochez "Skip OCR"
                    <br>üí° Word: Pas d'OCR n√©cessaire (extraction directe du contenu)
                </div>
            </div>

            <div class="form-row mt-3">
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input 
                                type="checkbox" 
                                name="skip_ocr" 
                                id="skip_ocr" 
                                style="width: auto;"
                            >
                            <label for="skip_ocr" style="margin: 0; font-size: 0.95rem; text-transform: none; letter-spacing: 0;">
                                ‚ö° Skip OCR (r√©utiliser markdown existant)
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input 
                                type="checkbox" 
                                name="use_llm" 
                                id="use_llm" 
                                checked
                                style="width: auto;"
                            >
                            <label for="use_llm" style="margin: 0; font-size: 0.95rem; text-transform: none; letter-spacing: 0;">
                                Activer la structuration LLM (Ollama)
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input 
                                type="checkbox" 
                                name="ingest_weaviate" 
                                id="ingest_weaviate" 
                                checked
                                style="width: auto;"
                            >
                            <label for="ingest_weaviate" style="margin: 0; font-size: 0.95rem; text-transform: none; letter-spacing: 0;">
                                Ins√©rer dans Weaviate (vectorisation)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="llm_provider">Provider LLM</label>
                    <select name="llm_provider" id="llm_provider" class="form-control" onchange="updateModelOptions()">
                        <option value="mistral" selected>‚ö° Mistral API (rapide)</option>
                        <option value="ollama">üñ•Ô∏è Ollama (local, lent)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="llm_model">Mod√®le LLM</label>
                    <select name="llm_model" id="llm_model" class="form-control">
                        <!-- Options Mistral API -->
                        <option value="mistral-small-latest" selected>mistral-small (rapide, √©conomique)</option>
                        <option value="mistral-medium-latest">mistral-medium (√©quilibr√©)</option>
                        <option value="mistral-large-latest">mistral-large (puissant)</option>
                    </select>
                </div>
                <script>
                function updateModelOptions() {
                    const provider = document.getElementById('llm_provider').value;
                    const modelSelect = document.getElementById('llm_model');
                    
                    if (provider === 'mistral') {
                        modelSelect.innerHTML = `
                            <option value="mistral-small-latest" selected>mistral-small (rapide, √©conomique)</option>
                            <option value="mistral-medium-latest">mistral-medium (√©quilibr√©)</option>
                            <option value="mistral-large-latest">mistral-large (puissant)</option>
                        `;
                    } else {
                        modelSelect.innerHTML = `
                            <option value="qwen2.5:7b" selected>qwen2.5:7b (recommand√©)</option>
                            <option value="qwen2.5:14b">qwen2.5:14b</option>
                            <option value="llama3.2:3b">llama3.2:3b (rapide)</option>
                            <option value="mistral:7b">mistral:7b</option>
                        `;
                    }
                }
                </script>
            </div>

            <!-- Options Extraction TOC am√©lior√©e -->
            <div class="card mt-4" style="border-left: 3px solid #4CAF50;">
                <h4 style="color: #4CAF50;">üìë Extraction TOC am√©lior√©e (Recommand√©)</h4>
                <p style="font-size: 0.9rem; color: #666;">
                    Analyse l'indentation du texte pour d√©tecter automatiquement la hi√©rarchie de la table des mati√®res.
                    <br><strong style="color: #4CAF50;">‚úÖ Fiable, rapide et sans co√ªt suppl√©mentaire</strong>
                </p>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 1rem;">
                    <input 
                        type="checkbox" 
                        name="use_ocr_annotations" 
                        id="use_ocr_annotations"
                        style="width: auto;"
                        checked
                    >
                    <label for="use_ocr_annotations" style="margin: 0; font-size: 0.95rem; font-weight: 600;">
                        Activer l'analyse d'indentation pour la TOC
                    </label>
                </div>
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f0f9f0; border-radius: 4px; font-size: 0.85rem;">
                    <strong>Fonctionnement :</strong> D√©tecte les niveaux hi√©rarchiques en comptant les espaces d'indentation dans la table des mati√®res.
                    <br>
                    <em>Id√©al pour les documents acad√©miques avec TOC structur√©e.</em>
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                    Analyser le document
                </button>
            </div>
        </form>
    </div>

    <hr class="divider">

    <div class="card">
        <h3>üìã Pipeline de traitement</h3>
        <div class="mt-2">
            <p><strong>PDF:</strong></p>
            <p style="margin-left: 1rem;">1. OCR Mistral ‚Äî Extraction du texte et des images via l'API Mistral</p>
            <p style="margin-left: 1rem;">2. Markdown ‚Äî Construction du document Markdown avec images</p>
            <p style="margin-left: 1rem;">3. Hi√©rarchie ‚Äî Analyse des titres pour cr√©er une structure arborescente</p>
            <p style="margin-left: 1rem;">4. LLM (optionnel) ‚Äî Am√©lioration de la structure via Ollama/Mistral</p>

            <p class="mt-3"><strong>Word (.docx):</strong></p>
            <p style="margin-left: 1rem;">1. Extraction Word ‚Äî Lecture directe du contenu (pas d'OCR)</p>
            <p style="margin-left: 1rem;">2. Markdown ‚Äî Construction du document Markdown √† partir des paragraphes</p>
            <p style="margin-left: 1rem;">3. TOC ‚Äî Extraction de la hi√©rarchie depuis les styles Heading 1-9</p>
            <p style="margin-left: 1rem;">4. LLM ‚Äî Structuration s√©mantique et enrichissement</p>
        </div>
    </div>

    <div class="card mt-3">
        <h3>üìÅ Fichiers g√©n√©r√©s</h3>
        <div class="mt-2">
            <ul style="list-style: none;">
                <li class="mb-1"><span class="badge">document.md</span> Texte Markdown OCR</li>
                <li class="mb-1"><span class="badge">document_chunks.json</span> Chunks hi√©rarchiques</li>
                <li class="mb-1"><span class="badge">document_structured.json</span> Structure LLM</li>
                <li class="mb-1"><span class="badge">document_ocr.json</span> R√©ponse OCR brute</li>
                <li><span class="badge">images/</span> Images extraites</li>
            </ul>
        </div>
    </div>

    <div class="text-center mt-4">
        <a href="/documents" class="btn">Voir les documents trait√©s</a>
    </div>
</section>
{% endblock %}

